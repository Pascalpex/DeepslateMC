From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Pascalpex <pascalpex@gmail.com>
Date: Mon, 25 Dec 2023 15:20:22 +0100
Subject: [PATCH] Maintenance mode


diff --git a/src/main/java/net/minecraft/server/dedicated/DedicatedServer.java b/src/main/java/net/minecraft/server/dedicated/DedicatedServer.java
index 27a05dd4a0a117a6a6d7283a84522915132b8186..86e3062ea9f11d293416d8bc9a5eead55e13753e 100644
--- a/src/main/java/net/minecraft/server/dedicated/DedicatedServer.java
+++ b/src/main/java/net/minecraft/server/dedicated/DedicatedServer.java
@@ -251,6 +251,7 @@ public class DedicatedServer extends MinecraftServer implements ServerInterface
         MinecraftServer.getServer().server.getCommandMap().register("clearchat", "Deepslate", new ClearchatCommand("clearchat"));
         MinecraftServer.getServer().server.getCommandMap().register("setbuildworld", "Deepslate", new BuildworldCommand("setbuildworld"));
         MinecraftServer.getServer().server.getCommandMap().register("buildworld", "Deepslate", new BuildworldCommand("buildworld"));
+        MinecraftServer.getServer().server.getCommandMap().register("maintenance", "Deepslate", new MaintenanceMode("maintenance"));
         // Deepslate end
 
         this.setPvpAllowed(dedicatedserverproperties.pvp);
diff --git a/src/main/java/net/minecraft/server/players/PlayerList.java b/src/main/java/net/minecraft/server/players/PlayerList.java
index b79c9c983dc960732927bbc13017e7eb028e485b..946e55d30c83470643bb99ce8bea2cfc01169abf 100644
--- a/src/main/java/net/minecraft/server/players/PlayerList.java
+++ b/src/main/java/net/minecraft/server/players/PlayerList.java
@@ -103,6 +103,8 @@ import net.minecraft.world.phys.Vec3;
 import net.minecraft.world.scores.DisplaySlot;
 import net.minecraft.world.scores.Objective;
 import net.minecraft.world.scores.PlayerTeam;
+import net.pascalpex.deepslatemc.Config;
+import net.pascalpex.deepslatemc.MessagesFile;
 import org.galemc.gale.configuration.GaleGlobalConfiguration;
 import org.slf4j.Logger;
 
@@ -355,6 +357,15 @@ public abstract class PlayerList {
         player.containerMenu.transferTo(player.containerMenu, bukkitPlayer);
 
         PlayerJoinEvent playerJoinEvent = new PlayerJoinEvent(bukkitPlayer, io.papermc.paper.adventure.PaperAdventure.asAdventure(ichatmutablecomponent)); // Paper - Adventure
+        // Deepslate start - Maintenance mode
+        if(Config.getMaintenanceMode()) {
+            if(!bukkitPlayer.hasPermission("deepslate.maintenancebypass")) {
+                String prefix = MessagesFile.getPrefix();
+                bukkitPlayer.kickPlayer(prefix + MessagesFile.getMaintenanceKick());
+                return;
+            }
+        }
+        // Deepslate end
         this.cserver.getPluginManager().callEvent(playerJoinEvent);
 
         if (!player.connection.isAcceptingMessages()) {
diff --git a/src/main/java/net/pascalpex/deepslatemc/Config.java b/src/main/java/net/pascalpex/deepslatemc/Config.java
index 14630aad16fe8ac38030674c52bc91d619e9abde..97119bdc69d79216241bf1cf0c0b2ae5b230134b 100644
--- a/src/main/java/net/pascalpex/deepslatemc/Config.java
+++ b/src/main/java/net/pascalpex/deepslatemc/Config.java
@@ -30,6 +30,9 @@ public class Config {
             if(!config.contains("discordLink")) {
                 config.set("discordLink", "https://discord.gg/BGrhNnVczp");
             }
+            if(!config.contains("maintenance")) {
+                config.set("maintenance", false);
+            }
             save();
         } catch (IOException | InvalidConfigurationException e) {
             e.printStackTrace();
@@ -54,5 +57,12 @@ public class Config {
         config.set("buildworld", worldName);
         save();
     }
+    public static boolean getMaintenanceMode() {
+        return config.getBoolean("maintenance");
+    }
+    public static void toggleMaintenanceMode() {
+        config.set("maintenance", !getMaintenanceMode());
+        save();
+    }
 
 }
diff --git a/src/main/java/net/pascalpex/deepslatemc/MessagesFile.java b/src/main/java/net/pascalpex/deepslatemc/MessagesFile.java
index b9a05e9efa2db4d7a9b93e2df3394cd8351c844c..b17adb308859c5c9fe0958d56d0cb31286c72774 100644
--- a/src/main/java/net/pascalpex/deepslatemc/MessagesFile.java
+++ b/src/main/java/net/pascalpex/deepslatemc/MessagesFile.java
@@ -56,6 +56,15 @@ public class MessagesFile {
             if(!config.contains("buildworldNotSet")) {
                 config.set("buildworldNotSet", "&cThe buildworld is not set");
             }
+            if (!config.contains("maintenanceKick")) {
+                config.set("maintenanceKick", "&cThe server is currently in maintenance mode");
+            }
+            if (!config.contains("maintenanceOn")) {
+                config.set("maintenanceOn", "&aYou turned on the maintenance mode");
+            }
+            if (!config.contains("maintenanceOff")) {
+                config.set("maintenanceOff", "&aYou turned off the maintenance mode");
+            }
             save();
         } catch (IOException | InvalidConfigurationException e) {
             e.printStackTrace();
@@ -110,5 +119,17 @@ public class MessagesFile {
         String prefix = config.getString("buildworldNotSet");
         return prefix.replace("&", "ยง");
     }
+    public static String getMaintenanceKick() {
+        String prefix = config.getString("maintenanceKick");
+        return prefix.replace("&", "ยง");
+    }
+    public static String getMaintenanceOn() {
+        String prefix = config.getString("maintenanceOn");
+        return prefix.replace("&", "ยง");
+    }
+    public static String getMaintenanceOff() {
+        String prefix = config.getString("maintenanceOff");
+        return prefix.replace("&", "ยง");
+    }
 
 }
diff --git a/src/main/java/net/pascalpex/deepslatemc/commands/MaintenanceMode.java b/src/main/java/net/pascalpex/deepslatemc/commands/MaintenanceMode.java
new file mode 100644
index 0000000000000000000000000000000000000000..213d709d0c0ff430420f6ee885f5ea6e4a94e837
--- /dev/null
+++ b/src/main/java/net/pascalpex/deepslatemc/commands/MaintenanceMode.java
@@ -0,0 +1,43 @@
+package net.pascalpex.deepslatemc.commands;
+
+import net.pascalpex.deepslatemc.Config;
+import net.pascalpex.deepslatemc.MessagesFile;
+import org.bukkit.command.Command;
+import org.bukkit.command.CommandSender;
+import org.bukkit.entity.Player;
+
+public class MaintenanceMode extends Command {
+    public MaintenanceMode(String name) {
+        super(name);
+        this.description = "Toggles the maintenance mode";
+        this.usageMessage = "/maintenance";
+        setPermission("deepslate.maintenance");
+    }
+
+    public boolean execute(CommandSender sender, String label, String[] args) {
+        String prefix = MessagesFile.getPrefix() + " ";
+        if (sender instanceof Player) {
+            Player player = (Player)sender;
+            if (label.equalsIgnoreCase("maintenance") && player.hasPermission("deepslate.maintenance")) {
+                if (Config.getMaintenanceMode()) {
+                    player.sendMessage(prefix + MessagesFile.getMaintenanceOff());
+                } else {
+                    player.sendMessage(prefix + MessagesFile.getMaintenanceOn());
+                }
+                Config.toggleMaintenanceMode();
+            } else {
+                player.sendMessage(prefix + MessagesFile.getNoPermissions());
+            }
+        }
+        else if (label.equalsIgnoreCase("maintenance")) {
+            if (Config.getMaintenanceMode()) {
+                sender.sendMessage(prefix + MessagesFile.getMaintenanceOff());
+            } else {
+                sender.sendMessage(prefix + MessagesFile.getMaintenanceOn());
+            }
+            Config.toggleMaintenanceMode();
+        }
+
+        return true;
+    }
+}
diff --git a/src/main/java/org/bukkit/craftbukkit/CraftServer.java b/src/main/java/org/bukkit/craftbukkit/CraftServer.java
index 04e4889904511e4aa2c63b36ff4f693f9b5a90da..64f40507c4ef6ebe41cead9acf002bc3f3ae1519 100644
--- a/src/main/java/org/bukkit/craftbukkit/CraftServer.java
+++ b/src/main/java/org/bukkit/craftbukkit/CraftServer.java
@@ -1120,6 +1120,7 @@ public final class CraftServer implements Server {
         MinecraftServer.getServer().server.getCommandMap().register("clearchat", "Deepslate", new ClearchatCommand("clearchat"));
         MinecraftServer.getServer().server.getCommandMap().register("setbuildworld", "Deepslate", new BuildworldCommand("setbuildworld"));
         MinecraftServer.getServer().server.getCommandMap().register("buildworld", "Deepslate", new BuildworldCommand("buildworld"));
+        MinecraftServer.getServer().server.getCommandMap().register("maintenance", "Deepslate", new MaintenanceMode("maintenance"));
         // Deepslate end
 
         this.overrideAllCommandBlockCommands = this.commandsConfiguration.getStringList("command-block-overrides").contains("*");
